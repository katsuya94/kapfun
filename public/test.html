<!DOCTYPE HTML>
<html>
<head>
	<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
	<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
	<script type='text/javascript' src='js/schema.js'></script>
	<script type='text/javascript'>
	$(function() {
		var files;
		k = new kapfun();

		var captionCount = 0;

		var images = [];
		var captions = [];

		var queue = [
			'k.reset(work(3));',
			'for (var i = 0; i < 3; i++) images.push(k.addImage("url" + i, work(9)));',
			'for (var i = 0; i < 3; i++) for (var j = 0; j < 3; j++) captions.push(k.addCaption(images[i], "text" + i + j, [], work(9)));',
			'for (var i = 0; i < 9; i++) for (var j = 0; j < i; j++) k.shareCaption(captions[i]);'
		];
		var countdown = 1;
		var work = function(ops) {
			return function() {
				countdown--;
				console.log(countdown);
				if(countdown === 0) {
					countdown = ops;
					var exp = queue.shift();
					eval(exp);
				}
			};
		}
		work(1)();

		// var populateShares = function(caption, callback) {
		// 	captionCount++;
		// 	for(var i = 0; i < captionCount; i++)
		// 		k.shareCaption(caption);
		// 	callback();
		// }

		// var populateCaptions = function(image, callback) {
		// 	k.addCaption(image, 'text' + captionCount, [], function(i) {
		// 		populateShares(i, function() {
		// 			k.addCaption(image, 'text' + captionCount, [], function(j) {
		// 				populateShares(j, function() {
		// 					k.addCaption(image, 'text' + captionCount, [], function(k) {
		// 						populateShares(k, function() {
		// 							callback();
		// 						});
		// 					});
		// 				});
		// 			});
		// 		});
		// 	});
		// };

		// k.reset(function() {
		// 	k.addImage('url0', function(i) {
		// 		populateCaptions(i, function() {
		// 			k.addImage('url1', function(j) {
		// 				populateCaptions(j, function() {
		// 					k.addImage('url2', function(k) {
		// 						populateCaptions(k, function() {});
		// 					});
		// 				});
		// 			});
		// 		});
		// 	});
		// });

		$('#file').on('change', function(event) {
			files = event.target.files;
		});

		function success(result) {
			k.addImage('https://imgur.com/gallery/' + result.data.id);
		}

		$('#form').on('submit', function(event) {
			event.stopPropagation();
			event.preventDefault();

			if($('#url').val().length) {
				$.ajax({
					url: 'https://api.imgur.com/3/image',
					method: 'POST',
					cache: false,
					headers: {
						Authorization: 'Client-ID 5b607a26ccbd041',
					},
					data: {
						image: $('#url').val()
					},
					success: success
				});
			} else {
				var data = new FormData();
				data.append('image', files[0]);

				console.log(data);

				$.ajax({
					url: 'https://api.imgur.com/3/image',
					method: 'POST',
					cache: false,
					contentType: false,
					processData: false,
					headers: {
						Authorization: 'Client-ID 5b607a26ccbd041',
					},
					data: data,
					success: success
				});
			}
		});
	});
	</script>
</head>
<body>
	<form id="form" action="#" method="post" enctype="multipart/form-data">
		<label for="file">Filename:</label>
		<input type="file" name="image" id="file" /><br />
		<label for="url">URL:</label>
		<input type="url" name="image" id="url" /><br />
		<input type="submit" name="submit" value="Submit">
	</form>

</body>
</html>
